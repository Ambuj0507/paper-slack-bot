name: Daily Paper Post

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      days_back:
        description: 'Number of days to look back'
        required: false
        default: '1'
        type: string

# Minimum permissions needed for this workflow
permissions:
  contents: read

jobs:
  post-papers:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install --no-interaction

      - name: Create config file
        run: |
          cat > config.yml << EOF
          slack:
            bot_token: "\${SLACK_BOT_TOKEN}"
            app_token: "\${SLACK_APP_TOKEN}"
            channel_id: "${{ secrets.SLACK_CHANNEL_ID }}"
          
          ncbi_api_key: "\${NCBI_API_KEY}"
          openai_api_key: "\${OPENAI_API_KEY}"
          
          search:
            keywords:
              - "machine learning"
              - "deep learning"
              - "computational biology"
            databases:
              - pubmed
              - biorxiv
              - arxiv
            days_back: ${{ github.event.inputs.days_back || '1' }}
          
          journals:
            include: []
            exclude: []
            tiers:
              - tier1
              - tier2
              - ml
            show_preprints: true
          
          llm:
            provider: "openai"
            model: "gpt-4o-mini"
            base_url: null
            filtering_prompt: |
              You are a research assistant helping filter scientific papers.
              Rate each paper's relevance from 0-100 and provide a brief explanation.
          
          schedule:
            enabled: false
            time: "09:00"
            timezone: "UTC"
          
          storage:
            database_path: "papers.db"
            cache_days: 30
          EOF

      - name: Post papers to Slack
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_APP_TOKEN: ${{ secrets.SLACK_APP_TOKEN }}
          NCBI_API_KEY: ${{ secrets.NCBI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          poetry run paper-slack-bot post --config config.yml --days ${{ github.event.inputs.days_back || '1' }}

      - name: Upload database artifact
        uses: actions/upload-artifact@v4
        with:
          name: papers-database
          path: papers.db
          retention-days: 7
